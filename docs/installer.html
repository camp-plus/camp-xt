<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>CAMP-XT One-click Installer</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <style>
      body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;padding:24px;background:#111;color:#eee}
      button{font-size:16px;padding:12px 16px;border-radius:8px;border:none;background:#2d8cff;color:#fff;cursor:pointer}
      pre{white-space:pre-wrap;background:#0b0b0b;padding:12px;border-radius:8px;overflow:auto}
      a { color:#9ad; }
    </style>
  </head>
  <body>
    <h1>CAMP-XT One-click Installer</h1>
    <p>This page fetches the latest <code>overlay-all.user.js</code> and opens it so your userscript manager can install it.</p>
    <p>
      <button id="install">Fetch &amp; Install latest</button>
      <button id="view" style="margin-left:8px;background:#444">View source</button>
      <a id="direct" style="margin-left:8px" href="#" target="_blank" rel="noopener">Open direct</a>
    </p>
    <pre id="log" style="display:none"></pre>
    <script>
      const cdnUrl = 'https://cdn.jsdelivr.net/gh/camp-plus/camp-xt@main/scripts/overlay-all.user.js';
      const rawUrl = 'https://raw.githubusercontent.com/camp-plus/camp-xt/main/scripts/overlay-all.user.js';

      const direct = document.getElementById('direct');
      direct.href = cdnUrl; // open direct install link in a new tab

      async function fetchLatest() {
        let res;
        try {
          res = await fetch(cdnUrl + '?_=' + Date.now(), { cache: 'no-store', credentials: 'omit' });
        } catch (e) { /* ignore */ }
        if (!res || !res.ok) {
          res = await fetch(rawUrl + '?_=' + Date.now(), { cache: 'no-store', credentials: 'omit' });
          if (!res.ok) throw new Error('Fetch failed: ' + res.status);
        }
        return res.text();
      }

      async function fetchAndOpen() {
        const log = document.getElementById('log');
        try {
          log.style.display = 'block';
          log.textContent = 'Fetching latest script...';
          const text = await fetchLatest();
          log.textContent = 'Fetched ' + text.length + ' bytes. Opening installer...';

          const blob = new Blob([text], { type: 'text/javascript' });
          const url = URL.createObjectURL(blob);
          window.open(url, '_blank');
          setTimeout(() => URL.revokeObjectURL(url), 2000);
          log.textContent += '\nOpened installer in a new tab.';
        } catch (err) {
          log.textContent = 'Error: ' + (err && err.message ? err.message : String(err));
        }
      }

      document.getElementById('install').addEventListener('click', fetchAndOpen);
      document.getElementById('view').addEventListener('click', async () => {
        const log = document.getElementById('log');
        log.style.display = 'block';
        try {
          const text = await fetchLatest();
          const w = window.open();
          w.document.write('<pre>' + escapeHtml(text) + '</pre>');
          w.document.close();
        } catch (e) {
          log.textContent = 'View error: ' + (e && e.message ? e.message : String(e));
        }
      });

      function escapeHtml(s){ return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
    </script>
  </body>
  </html>
